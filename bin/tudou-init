#!/usr/bin/env node

const download = require('download-git-repo')
const program = require('commander')
const chalk = require('chalk')
const exists = require('fs').existsSync
const inquirer = require('inquirer')
const rm = require('rimraf').sync

/**
 * Usage.
 */
program
  .usage('<branch> [project-name]')
  .option('branch', 'é€‰æ‹©éœ€è¦ä¸‹è½½å¾—åˆ†æ”¯ï¼Œå¯ä½¿ç”¨"tudou list"æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯')
  .option('project-name', 'è¦åˆ›å»ºå¾—é¡¹ç›®å')

/**
 * Help.
 */
program.on('--help', () => {
  console.log('  Examples:')
  console.log()
  console.log(chalk.gray('    # æ ¹æ®è¾“å…¥çš„åˆ†æ”¯åˆ›å»ºä¸€ä¸ªæ–°çš„åŸºç¡€å·¥ç¨‹'))
  console.log('    $ tudou init master web-project')
  console.log()
  console.log(chalk.gray('    # å¯ä»¥ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯'))
  console.log('    $ tudou list')
  console.log()
})

/**
 * Help.
 */

function help () {
  program.parse(process.argv)
  if (program.args.length < 1) return program.help()
}
help()

let branch = program.args[0] || 'master'
let projectName = program.args[1] || 'frontend'

// function askQuestions (prompts) {
//   return (files, metalsmith, done) => {
//     ask(prompts, metalsmith.metadata(), done)
//   }
// }

if (exists(projectName)) {
  inquirer.prompt([{
    type: 'confirm',
    message: projectName + 'æ–‡ä»¶å¤¹å·²ç»å­˜åœ¨ï¼Œæ˜¯å¦åˆ é™¤åç»§ç»­ä¸‹è½½(ä¸è¾“é»˜è®¤ç»§ç»­)',
    name: 'ok'
  }]).then(answers => {
    if (answers.ok) {
      downloadAndGenerate(branch, projectName)
    } else {
      console.log(chalk.blue('\nå–æ¶ˆä¸‹è½½ï¼Œç¨‹åºç»ˆæ­¢\n'))
    }
  }).catch(function (err) {
    console.log(chalk.red(err))
  })
} else {
  downloadAndGenerate(branch, projectName)
}

function downloadAndGenerate (branch, project) {
  if (exists(project)) {
    rm(project)
  }
  console.log(chalk.yellow(
    '\n' +
    'åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶ \n' +
    'æ­£åœ¨æ‹‰å–æ¨¡æ¿ä»£ç ï¼Œä¸‹è½½ä½ç½®ï¼šhttps://github.com/qm8956/tudou-frontend-cli/ ...' +
    '\n'
  ))
  download('direct:https://github.com/qm8956/tudou-frontend-cli.git#' + branch, project, { clone: true }, function (err) {
    if (err) {
      console.log(chalk.red('ErrorğŸ˜­!\n' + err))
    } else {
      console.log(chalk.green(
        '\n' +
        'SuccessğŸ˜€\n' +
        'æ¨¡æ¿å·¥ç¨‹å»ºç«‹å®Œæˆ\n' +
        'cd ' + projectName + '\n' +
        'npm install\n' +
        'npm run dev\n'
      ))
    }
  })
}

program.parse(process.argv)
